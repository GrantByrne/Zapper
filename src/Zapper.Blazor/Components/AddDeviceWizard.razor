
@using Zapper.Contracts

<MudDialog @bind-Visible="IsVisible" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            @if (_currentStep == WizardStep.DeviceType)
            {
                <span>Add New Device - Select Type</span>
            }
            else if (_currentStep == WizardStep.BluetoothScan)
            {
                <span>Add New Device - Scan for @_selectedDeviceTypeName Devices</span>
            }
            else if (_currentStep == WizardStep.WebOsScan)
            {
                <span>Add New Device - Scan for @_selectedDeviceTypeName TVs</span>
            }
            else if (_currentStep == WizardStep.PlayStationScan)
            {
                <span>Add New Device - Scan for PlayStation Consoles</span>
            }
            else if (_currentStep == WizardStep.XboxScan)
            {
                <span>Add New Device - Scan for Xbox Consoles</span>
            }
            else if (_currentStep == WizardStep.RokuScan)
            {
                <span>Add New Device - Scan for Roku Devices</span>
            }
            else if (_currentStep == WizardStep.YamahaScan)
            {
                <span>Add New Device - Scan for Yamaha Receivers</span>
            }
            else if (_currentStep == WizardStep.SonosScan)
            {
                <span>Add New Device - Scan for Sonos Speakers</span>
            }
            else if (_currentStep == WizardStep.IrCodeSelection)
            {
                <span>Add New Device - Select IR Codes</span>
            }
            else if (_currentStep == WizardStep.Configuration)
            {
                <span>Add New Device - Configure @_selectedDeviceTypeName</span>
            }
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_currentStep == WizardStep.DeviceType)
        {
            <MudText Class="mb-4">Choose the type of device you want to add:</MudText>
            <MudGrid>
                <MudItem xs="6" sm="4">
                    <MudCard Class="@GetCardClass(ConnectionType.Bluetooth, false)" 
                             Style="cursor: pointer;" @onclick="@(() => SelectDeviceTypeAndProceed(ConnectionType.Bluetooth, "Bluetooth"))">
                        <MudCardContent Class="text-center pa-4">
                            <MudIcon Icon="@Icons.Material.Filled.Bluetooth" Size="Size.Large" Class="mb-2" />
                            <MudText Typo="Typo.h6">Bluetooth</MudText>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                Apple TV, Android TV, Controllers
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="6" sm="4">
                    <MudCard Class="@GetCardClass(ConnectionType.InfraredIr, false)" 
                             Style="cursor: pointer;" @onclick="@(() => SelectDeviceTypeAndProceed(ConnectionType.InfraredIr, "Infrared"))">
                        <MudCardContent Class="text-center pa-4">
                            <MudIcon Icon="@Icons.Material.Filled.Sensors" Size="Size.Large" Class="mb-2" />
                            <MudText Typo="Typo.h6">Infrared</MudText>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                TVs, Sound Bars, Cable Boxes
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="6" sm="4">
                    <MudCard Class="@GetCardClass(ConnectionType.NetworkHttp, true)" 
                             Style="cursor: pointer;" @onclick="@(() => SelectDeviceTypeAndProceed(ConnectionType.NetworkHttp, "Roku", true))">
                        <MudCardContent Class="text-center pa-4">
                            <MudIcon Icon="@Icons.Material.Filled.Cast" Size="Size.Large" Class="mb-2" />
                            <MudText Typo="Typo.h6">Roku</MudText>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                Roku Streaming Devices
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="6" sm="4">
                    <MudCard Class="@GetCardClass(ConnectionType.WebOs, false)" 
                             Style="cursor: pointer;" @onclick="@(() => SelectDeviceTypeAndProceed(ConnectionType.WebOs, "WebOS"))">
                        <MudCardContent Class="text-center pa-4">
                            <MudIcon Icon="@Icons.Material.Filled.Tv" Size="Size.Large" Class="mb-2" />
                            <MudText Typo="Typo.h6">WebOS</MudText>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                LG Smart TVs
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="6" sm="4">
                    <MudCard Class="device-type-card" 
                             Style="cursor: pointer;" @onclick="@(() => SelectPlayStationType())">
                        <MudCardContent Class="text-center pa-4">
                            <MudIcon Icon="@Icons.Material.Filled.SportsEsports" Size="Size.Large" Class="mb-2" />
                            <MudText Typo="Typo.h6">PlayStation</MudText>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                PS4, PS5 Consoles
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="6" sm="4">
                    <MudCard Class="device-type-card" 
                             Style="cursor: pointer;" @onclick="@(() => SelectXboxType())">
                        <MudCardContent Class="text-center pa-4">
                            <MudIcon Icon="@Icons.Material.Filled.VideogameAsset" Size="Size.Large" Class="mb-2" />
                            <MudText Typo="Typo.h6">Xbox</MudText>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                Xbox One, Series X/S
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="6" sm="4">
                    <MudCard Class="device-type-card" 
                             Style="cursor: pointer;" @onclick="@(() => SelectYamahaType())">
                        <MudCardContent Class="text-center pa-4">
                            <MudIcon Icon="@Icons.Material.Filled.Speaker" Size="Size.Large" Class="mb-2" />
                            <MudText Typo="Typo.h6">Yamaha</MudText>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                MusicCast Receivers
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="6" sm="4">
                    <MudCard Class="device-type-card" 
                             Style="cursor: pointer;" @onclick="@(() => SelectSonosType())">
                        <MudCardContent Class="text-center pa-4">
                            <MudIcon Icon="@Icons.Material.Filled.SpeakerGroup" Size="Size.Large" Class="mb-2" />
                            <MudText Typo="Typo.h6">Sonos</MudText>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                Wireless Speakers
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        }
        else if (_currentStep == WizardStep.BluetoothScan)
        {
            <MudText Class="mb-4">Scanning for available Bluetooth devices...</MudText>
            
            @if (_isScanning)
            {
                <div class="d-flex justify-center align-center" style="min-height: 200px;">
                    <div class="text-center">
                        <MudProgressCircular Size="Size.Large" Indeterminate="true" Class="mb-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Scanning for devices...</MudText>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">
                            Please make sure your devices are in pairing mode
                        </MudText>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(_scanError))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">
                    @_scanError
                </MudAlert>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartBluetoothScan" Class="mb-4">
                    Retry Scan
                </MudButton>
            }
            else if (_discoveredBluetoothDevices.Any())
            {
                <MudText Class="mb-3">Found @_discoveredBluetoothDevices.Count() device(s). Select the device you want to add:</MudText>
                <div class="mb-4">
                    @foreach (var device in _discoveredBluetoothDevices)
                    {
                        <MudButton FullWidth="true" 
                                  Color="@(_selectedBluetoothDevice == device ? Color.Primary : Color.Default)"
                                  Variant="@(_selectedBluetoothDevice == device ? Variant.Filled : Variant.Outlined)"
                                  OnClick="@(() => SelectBluetoothDevice(device))"
                                  Class="mb-2">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.Bluetooth" Class="mr-3" />
                                <div class="text-left">
                                    <MudText Typo="Typo.subtitle1">@device</MudText>
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">Bluetooth Device</MudText>
                                </div>
                            </div>
                        </MudButton>
                    }
                </div>
                <MudButton Color="Color.Secondary" Variant="Variant.Text" OnClick="StartBluetoothScan" StartIcon="@Icons.Material.Filled.Refresh" Class="mt-2">
                    Rescan
                </MudButton>
            }
            else
            {
                <MudAlert Severity="Severity.Warning" Class="mb-4">
                    No Bluetooth devices found. Make sure your devices are powered on and in pairing mode.
                </MudAlert>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartBluetoothScan" Class="mb-4">
                    Start Scan
                </MudButton>
            }
        }
        else if (_currentStep == WizardStep.WebOsScan)
        {
            <MudText Class="mb-4">Scanning for available WebOS TVs on your network...</MudText>
            
            @if (_isWebOsScanning)
            {
                <div class="d-flex justify-center align-center" style="min-height: 200px;">
                    <div class="text-center">
                        <MudProgressCircular Size="Size.Large" Indeterminate="true" Class="mb-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Scanning for WebOS TVs...</MudText>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">
                            Please make sure your TV is powered on and connected to the network
                        </MudText>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(_webOsScanError))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">
                    @_webOsScanError
                </MudAlert>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartWebOsScan" Class="mb-4">
                    Retry Scan
                </MudButton>
            }
            else if (_discoveredWebOsDevices.Any())
            {
                <MudText Class="mb-3">Found @_discoveredWebOsDevices.Count() TV(s). Select the TV you want to add:</MudText>
                <div class="mb-4">
                    @foreach (var device in _discoveredWebOsDevices)
                    {
                        <MudButton FullWidth="true" 
                                  Color="@(_selectedWebOsDevice?.Name == device.Name ? Color.Primary : Color.Default)"
                                  Variant="@(_selectedWebOsDevice?.Name == device.Name ? Variant.Filled : Variant.Outlined)"
                                  OnClick="@(() => SelectWebOsDevice(device))"
                                  Class="mb-2">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.Tv" Class="mr-3" />
                                <div class="text-left">
                                    <MudText Typo="Typo.subtitle1">@device.Name</MudText>
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">@device.IpAddress</MudText>
                                    @if (!string.IsNullOrEmpty(device.ModelName))
                                    {
                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@device.ModelName</MudText>
                                    }
                                </div>
                            </div>
                        </MudButton>
                    }
                </div>
                <MudButton Color="Color.Secondary" Variant="Variant.Text" OnClick="StartWebOsScan" StartIcon="@Icons.Material.Filled.Refresh" Class="mt-2">
                    Rescan
                </MudButton>
            }
            else
            {
                <MudAlert Severity="Severity.Warning" Class="mb-4">
                    No WebOS TVs found on your network. Make sure your TV is powered on and connected to the same network.
                </MudAlert>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartWebOsScan" Class="mb-4">
                    Start Scan
                </MudButton>
            }
            
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.h6" Class="mb-2">Or enter IP address manually:</MudText>
            <MudTextField @bind-Value="_manualWebOsIpAddress" Label="TV IP Address" 
                         HelperText="Enter the IP address of your WebOS TV (e.g., 192.168.1.100)" 
                         Class="mb-2" />
            <MudButton Color="Color.Secondary" Variant="Variant.Outlined" OnClick="UseManualWebOsip" 
                      Disabled="@(string.IsNullOrWhiteSpace(_manualWebOsIpAddress))" Class="mb-4">
                Use This IP Address
            </MudButton>
        }
        else if (_currentStep == WizardStep.PlayStationScan)
        {
            <MudText Class="mb-4">Scanning for available PlayStation consoles on your network...</MudText>
            
            @if (_isPlayStationScanning)
            {
                <div class="d-flex justify-center align-center" style="min-height: 200px;">
                    <div class="text-center">
                        <MudProgressCircular Size="Size.Large" Indeterminate="true" Class="mb-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Scanning for PlayStation consoles...</MudText>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">
                            Please make sure your PlayStation is powered on and connected to the network
                        </MudText>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(_playStationScanError))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">
                    @_playStationScanError
                </MudAlert>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartPlayStationScan" Class="mb-4">
                    Retry Scan
                </MudButton>
            }
            else if (_discoveredPlayStationDevices.Any())
            {
                <MudText Class="mb-3">Found @_discoveredPlayStationDevices.Count() console(s). Select the console you want to add:</MudText>
                <div class="mb-4">
                    @foreach (var device in _discoveredPlayStationDevices)
                    {
                        <MudButton FullWidth="true" 
                                  Color="@(_selectedPlayStationDevice?.Name == device.Name ? Color.Primary : Color.Default)"
                                  Variant="@(_selectedPlayStationDevice?.Name == device.Name ? Variant.Filled : Variant.Outlined)"
                                  OnClick="@(() => SelectPlayStationDevice(device))"
                                  Class="mb-2">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.SportsEsports" Class="mr-3" />
                                <div class="text-left">
                                    <MudText Typo="Typo.subtitle1">@device.Name</MudText>
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">@device.IpAddress</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@device.Model</MudText>
                                </div>
                            </div>
                        </MudButton>
                    }
                </div>
                <MudButton Color="Color.Secondary" Variant="Variant.Text" OnClick="StartPlayStationScan" StartIcon="@Icons.Material.Filled.Refresh" Class="mt-2">
                    Rescan
                </MudButton>
            }
            else
            {
                <MudAlert Severity="Severity.Warning" Class="mb-4">
                    No PlayStation consoles found on your network. Make sure your console is powered on and connected to the same network.
                </MudAlert>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartPlayStationScan" Class="mb-4">
                    Start Scan
                </MudButton>
            }
            
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.h6" Class="mb-2">Or enter IP address manually:</MudText>
            <MudTextField @bind-Value="_manualPlayStationIpAddress" Label="Console IP Address" 
                         HelperText="Enter the IP address of your PlayStation console (e.g., 192.168.1.100)" 
                         Class="mb-2" />
            <MudButton Color="Color.Secondary" Variant="Variant.Outlined" OnClick="UseManualPlayStationIp" 
                      Disabled="@(string.IsNullOrWhiteSpace(_manualPlayStationIpAddress))" Class="mb-4">
                Use This IP Address
            </MudButton>
        }
        else if (_currentStep == WizardStep.XboxScan)
        {
            <MudText Class="mb-4">Scanning for available Xbox consoles on your network...</MudText>
            
            @if (_isXboxScanning)
            {
                <div class="d-flex justify-center align-center" style="min-height: 200px;">
                    <div class="text-center">
                        <MudProgressCircular Size="Size.Large" Indeterminate="true" Class="mb-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Scanning for Xbox consoles...</MudText>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">
                            Please make sure your Xbox is powered on and connected to the network
                        </MudText>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(_xboxScanError))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">
                    @_xboxScanError
                </MudAlert>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartXboxScan" Class="mb-4">
                    Retry Scan
                </MudButton>
            }
            else if (_discoveredXboxDevices.Any())
            {
                <MudText Class="mb-3">Found @_discoveredXboxDevices.Count() console(s). Select the console you want to add:</MudText>
                <div class="mb-4">
                    @foreach (var device in _discoveredXboxDevices)
                    {
                        <MudButton FullWidth="true" 
                                  Color="@(_selectedXboxDevice?.Name == device.Name ? Color.Primary : Color.Default)"
                                  Variant="@(_selectedXboxDevice?.Name == device.Name ? Variant.Filled : Variant.Outlined)"
                                  OnClick="@(() => SelectXboxDevice(device))"
                                  Class="mb-2">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.SportsEsports" Class="mr-3" />
                                <div class="text-left">
                                    <MudText Typo="Typo.subtitle1">@device.Name</MudText>
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">@device.IpAddress</MudText>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@device.ConsoleType</MudText>
                                    @if (device.IsAuthenticated)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Class="ml-2">Authenticated</MudChip>
                                    }
                                </div>
                            </div>
                        </MudButton>
                    }
                </div>
                <MudButton Color="Color.Secondary" Variant="Variant.Text" OnClick="StartXboxScan" StartIcon="@Icons.Material.Filled.Refresh" Class="mt-2">
                    Rescan
                </MudButton>
            }
            else
            {
                <MudAlert Severity="Severity.Warning" Class="mb-4">
                    No Xbox consoles found on your network. Make sure your Xbox is powered on and connected to the same network.
                </MudAlert>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartXboxScan" Class="mb-4">
                    Start Scan
                </MudButton>
            }
            
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.h6" Class="mb-2">Or enter IP address manually:</MudText>
            <MudTextField @bind-Value="_manualXboxIpAddress" Label="Xbox IP Address" 
                         HelperText="Enter the IP address of your Xbox console (e.g., 192.168.1.100)" 
                         Class="mb-2" />
            <MudButton Color="Color.Secondary" Variant="Variant.Outlined" OnClick="UseManualXboxIp" 
                      Disabled="@(string.IsNullOrWhiteSpace(_manualXboxIpAddress))" Class="mb-4">
                Use This IP Address
            </MudButton>
        }
        else if (_currentStep == WizardStep.RokuScan)
        {
            <MudText Class="mb-4">Scanning for available Roku devices on your network...</MudText>
            
            @if (_isRokuScanning)
            {
                <div class="d-flex justify-center align-center" style="min-height: 200px;">
                    <div class="text-center">
                        <MudProgressCircular Size="Size.Large" Indeterminate="true" Class="mb-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Scanning for Roku devices...</MudText>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">
                            Please make sure your Roku is powered on and connected to the network
                        </MudText>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(_rokuScanError))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">
                    @_rokuScanError
                </MudAlert>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartRokuScan" Class="mb-4">
                    Retry Scan
                </MudButton>
            }
            else if (_discoveredRokuDevices.Any())
            {
                <MudText Class="mb-3">Found @_discoveredRokuDevices.Count() device(s). Select the device you want to add:</MudText>
                <div class="mb-4">
                    @foreach (var device in _discoveredRokuDevices)
                    {
                        <MudButton FullWidth="true" 
                                  Color="@(_selectedRokuDevice?.Name == device.Name ? Color.Primary : Color.Default)"
                                  Variant="@(_selectedRokuDevice?.Name == device.Name ? Variant.Filled : Variant.Outlined)"
                                  OnClick="@(() => SelectRokuDevice(device))"
                                  Class="mb-2">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.Cast" Class="mr-3" />
                                <div class="text-left">
                                    <MudText Typo="Typo.subtitle1">@device.Name</MudText>
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">@device.IpAddress</MudText>
                                    @if (!string.IsNullOrEmpty(device.Model))
                                    {
                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@device.Model</MudText>
                                    }
                                </div>
                            </div>
                        </MudButton>
                    }
                </div>
                <MudButton Color="Color.Secondary" Variant="Variant.Text" OnClick="StartRokuScan" StartIcon="@Icons.Material.Filled.Refresh" Class="mt-2">
                    Rescan
                </MudButton>
            }
            else
            {
                <MudAlert Severity="Severity.Warning" Class="mb-4">
                    No Roku devices found on your network. Make sure your Roku is powered on and connected to the same network.
                </MudAlert>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartRokuScan" Class="mb-4">
                    Start Scan
                </MudButton>
            }
            
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.h6" Class="mb-2">Or enter IP address manually:</MudText>
            <MudTextField @bind-Value="_manualRokuIpAddress" Label="Roku IP Address" 
                         HelperText="Enter the IP address of your Roku device (e.g., 192.168.1.100)" 
                         Class="mb-2" />
            <MudButton Color="Color.Secondary" Variant="Variant.Outlined" OnClick="UseManualRokuIp" 
                      Disabled="@(string.IsNullOrWhiteSpace(_manualRokuIpAddress))" Class="mb-4">
                Use This IP Address
            </MudButton>
        }
        else if (_currentStep == WizardStep.YamahaScan)
        {
            <MudText Class="mb-4">Scanning for available Yamaha receivers on your network...</MudText>
            
            @if (_isYamahaScanning)
            {
                <div class="d-flex justify-center align-center" style="min-height: 200px;">
                    <div class="text-center">
                        <MudProgressCircular Size="Size.Large" Indeterminate="true" Class="mb-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Scanning for Yamaha receivers...</MudText>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">
                            Please make sure your receiver is powered on and connected to the network
                        </MudText>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(_yamahaScanError))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">
                    @_yamahaScanError
                </MudAlert>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartYamahaScan" Class="mb-4">
                    Retry Scan
                </MudButton>
            }
            else if (_discoveredYamahaDevices.Any())
            {
                <MudText Class="mb-3">Found @_discoveredYamahaDevices.Count() receiver(s). Select the receiver you want to add:</MudText>
                <div class="mb-4">
                    @foreach (var device in _discoveredYamahaDevices)
                    {
                        <MudButton FullWidth="true" 
                                  Color="@(_selectedYamahaDevice?.Name == device.Name ? Color.Primary : Color.Default)"
                                  Variant="@(_selectedYamahaDevice?.Name == device.Name ? Variant.Filled : Variant.Outlined)"
                                  OnClick="@(() => SelectYamahaDevice(device))"
                                  Class="mb-2">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.Speaker" Class="mr-3" />
                                <div class="text-left">
                                    <MudText Typo="Typo.subtitle1">@device.Name</MudText>
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">@device.IpAddress</MudText>
                                    @if (!string.IsNullOrEmpty(device.Model))
                                    {
                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@device.Model</MudText>
                                    }
                                </div>
                            </div>
                        </MudButton>
                    }
                </div>
                <MudButton Color="Color.Secondary" Variant="Variant.Text" OnClick="StartYamahaScan" StartIcon="@Icons.Material.Filled.Refresh" Class="mt-2">
                    Rescan
                </MudButton>
            }
            else
            {
                <MudAlert Severity="Severity.Warning" Class="mb-4">
                    No Yamaha receivers found on your network. Make sure your receiver is powered on and connected to the same network.
                </MudAlert>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartYamahaScan" Class="mb-4">
                    Start Scan
                </MudButton>
            }
            
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.h6" Class="mb-2">Or enter IP address manually:</MudText>
            <MudTextField @bind-Value="_manualYamahaIpAddress" Label="Receiver IP Address" 
                         HelperText="Enter the IP address of your Yamaha receiver (e.g., 192.168.1.100)" 
                         Class="mb-2" />
            <MudButton Color="Color.Secondary" Variant="Variant.Outlined" OnClick="UseManualYamahaIp" 
                      Disabled="@(string.IsNullOrWhiteSpace(_manualYamahaIpAddress))" Class="mb-4">
                Use This IP Address
            </MudButton>
        }
        else if (_currentStep == WizardStep.SonosScan)
        {
            <MudText Class="mb-4">Scanning for available Sonos speakers on your network...</MudText>
            
            @if (_isSonosScanning)
            {
                <div class="d-flex justify-center align-center" style="min-height: 200px;">
                    <div class="text-center">
                        <MudProgressCircular Size="Size.Large" Indeterminate="true" Class="mb-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Scanning for Sonos speakers...</MudText>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">
                            Please make sure your speakers are powered on and connected to the network
                        </MudText>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(_sonosScanError))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">
                    @_sonosScanError
                </MudAlert>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartSonosScan" Class="mb-4">
                    Retry Scan
                </MudButton>
            }
            else if (_discoveredSonosDevices.Any())
            {
                <MudText Class="mb-3">Found @_discoveredSonosDevices.Count() speaker(s). Select the speaker you want to add:</MudText>
                <div class="mb-4">
                    @foreach (var device in _discoveredSonosDevices)
                    {
                        <MudButton FullWidth="true" 
                                  Color="@(_selectedSonosDevice?.Name == device.Name ? Color.Primary : Color.Default)"
                                  Variant="@(_selectedSonosDevice?.Name == device.Name ? Variant.Filled : Variant.Outlined)"
                                  OnClick="@(() => SelectSonosDevice(device))"
                                  Class="mb-2">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.SpeakerGroup" Class="mr-3" />
                                <div class="text-left">
                                    <MudText Typo="Typo.subtitle1">@device.Name</MudText>
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">@device.IpAddress</MudText>
                                    @if (!string.IsNullOrEmpty(device.Model))
                                    {
                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@device.Model</MudText>
                                    }
                                    @if (!string.IsNullOrEmpty(device.RoomName))
                                    {
                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">Room: @device.RoomName</MudText>
                                    }
                                </div>
                            </div>
                        </MudButton>
                    }
                </div>
                <MudButton Color="Color.Secondary" Variant="Variant.Text" OnClick="StartSonosScan" StartIcon="@Icons.Material.Filled.Refresh" Class="mt-2">
                    Rescan
                </MudButton>
            }
            else
            {
                <MudAlert Severity="Severity.Warning" Class="mb-4">
                    No Sonos speakers found on your network. Make sure your speakers are powered on and connected to the same network.
                </MudAlert>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartSonosScan" Class="mb-4">
                    Start Scan
                </MudButton>
            }
            
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.h6" Class="mb-2">Or enter IP address manually:</MudText>
            <MudTextField @bind-Value="_manualSonosIpAddress" Label="Speaker IP Address" 
                         HelperText="Enter the IP address of your Sonos speaker (e.g., 192.168.1.100)" 
                         Class="mb-2" />
            <MudButton Color="Color.Secondary" Variant="Variant.Outlined" OnClick="UseManualSonosIp" 
                      Disabled="@(string.IsNullOrWhiteSpace(_manualSonosIpAddress))" Class="mb-4">
                Use This IP Address
            </MudButton>
        }
        else if (_currentStep == WizardStep.IrCodeSelection)
        {
            <MudText Class="mb-4">Select or search for IR codes for your device:</MudText>
            <IrCodeSelector DeviceType="@MapToCoreDeviceType(_newDevice.Type)" OnCodeSetSelected="HandleIrCodeSetSelected" />
        }
        else if (_currentStep == WizardStep.Configuration)
        {
            <MudTextField @bind-Value="_newDevice.Name" Label="Device Name" Required="true" Class="mb-4" />
            <MudTextField @bind-Value="_newDevice.Brand" Label="Brand" Class="mb-4" />
            <MudTextField @bind-Value="_newDevice.Model" Label="Model" Class="mb-4" />
            
            <MudSelect T="DeviceType" @bind-Value="_newDevice.Type" Label="Device Type" Required="true" Class="mb-4">
                <MudSelectItem Value="DeviceType.Television">Television</MudSelectItem>
                <MudSelectItem Value="DeviceType.SmartTv">Smart TV</MudSelectItem>
                <MudSelectItem Value="DeviceType.SoundBar">Sound Bar</MudSelectItem>
                <MudSelectItem Value="DeviceType.StreamingDevice">Streaming Device</MudSelectItem>
                <MudSelectItem Value="DeviceType.AppleTv">Apple TV</MudSelectItem>
                <MudSelectItem Value="DeviceType.CableBox">Cable Box</MudSelectItem>
                <MudSelectItem Value="DeviceType.GameConsole">Game Console (Other)</MudSelectItem>
                <MudSelectItem Value="DeviceType.PlayStation">PlayStation</MudSelectItem>
                <MudSelectItem Value="DeviceType.Xbox">Xbox</MudSelectItem>
                <MudSelectItem Value="DeviceType.Receiver">Receiver</MudSelectItem>
                <MudSelectItem Value="DeviceType.Sonos">Sonos Speaker</MudSelectItem>
                <MudSelectItem Value="DeviceType.DvdPlayer">DVD Player</MudSelectItem>
                <MudSelectItem Value="DeviceType.BluRayPlayer">Blu-ray Player</MudSelectItem>
            </MudSelect>

            @if (_selectedConnectionType == ConnectionType.NetworkTcp || _selectedConnectionType == ConnectionType.NetworkWebSocket || _selectedConnectionType == ConnectionType.NetworkHttp || _selectedConnectionType == ConnectionType.WebOs)
            {
                <MudTextField @bind-Value="_newDevice.IpAddress" Label="IP Address" Required="true" Class="mb-4" 
                              HelperText="Enter the device's IP address (e.g., 192.168.1.100)" />
            }

            @if (_selectedConnectionType == ConnectionType.InfraredIr && _selectedIrCodeSetData != null)
            {
                <MudAlert Severity="Severity.Info" Class="mb-4">
                    Using IR codes: @_selectedIrCodeSetData.Brand @_selectedIrCodeSetData.Model
                </MudAlert>
            }

            @if (_selectedConnectionType == ConnectionType.Bluetooth)
            {
                <MudAlert Severity="Severity.Info" Class="mb-4">
                    Make sure your device is in pairing mode before proceeding.
                </MudAlert>
            }
        }
    </DialogContent>
    <DialogActions>
        @if (_currentStep == WizardStep.DeviceType)
        {
            <MudButton OnClick="CancelWizard">Cancel</MudButton>
        }
        else if (_currentStep == WizardStep.BluetoothScan)
        {
            <MudButton OnClick="PreviousStep">Back</MudButton>
            <MudButton OnClick="CancelWizard">Cancel</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="NextStep" Disabled="@(string.IsNullOrEmpty(_selectedBluetoothDevice))">
                Next
            </MudButton>
        }
        else if (_currentStep == WizardStep.WebOsScan)
        {
            <MudButton OnClick="PreviousStep">Back</MudButton>
            <MudButton OnClick="CancelWizard">Cancel</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="NextStep" Disabled="@(_selectedWebOsDevice == null && string.IsNullOrWhiteSpace(_manualWebOsIpAddress))">
                Next
            </MudButton>
        }
        else if (_currentStep == WizardStep.PlayStationScan)
        {
            <MudButton OnClick="PreviousStep">Back</MudButton>
            <MudButton OnClick="CancelWizard">Cancel</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="NextStep" Disabled="@(_selectedPlayStationDevice == null && string.IsNullOrWhiteSpace(_manualPlayStationIpAddress))">
                Next
            </MudButton>
        }
        else if (_currentStep == WizardStep.XboxScan)
        {
            <MudButton OnClick="PreviousStep">Back</MudButton>
            <MudButton OnClick="CancelWizard">Cancel</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="NextStep" Disabled="@(_selectedXboxDevice == null && string.IsNullOrWhiteSpace(_manualXboxIpAddress))">
                Next
            </MudButton>
        }
        else if (_currentStep == WizardStep.RokuScan)
        {
            <MudButton OnClick="PreviousStep">Back</MudButton>
            <MudButton OnClick="CancelWizard">Cancel</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="NextStep" Disabled="@(_selectedRokuDevice == null && string.IsNullOrWhiteSpace(_manualRokuIpAddress))">
                Next
            </MudButton>
        }
        else if (_currentStep == WizardStep.YamahaScan)
        {
            <MudButton OnClick="PreviousStep">Back</MudButton>
            <MudButton OnClick="CancelWizard">Cancel</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="NextStep" Disabled="@(_selectedYamahaDevice == null && string.IsNullOrWhiteSpace(_manualYamahaIpAddress))">
                Next
            </MudButton>
        }
        else if (_currentStep == WizardStep.SonosScan)
        {
            <MudButton OnClick="PreviousStep">Back</MudButton>
            <MudButton OnClick="CancelWizard">Cancel</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="NextStep" Disabled="@(_selectedSonosDevice == null && string.IsNullOrWhiteSpace(_manualSonosIpAddress))">
                Next
            </MudButton>
        }
        else if (_currentStep == WizardStep.IrCodeSelection)
        {
            <MudButton OnClick="PreviousStep">Back</MudButton>
            <MudButton OnClick="CancelWizard">Cancel</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="NextStep" Disabled="@(_selectedIrCodeSetData == null)">
                Next
            </MudButton>
        }
        else if (_currentStep == WizardStep.Configuration)
        {
            <MudButton OnClick="PreviousStep">Back</MudButton>
            <MudButton OnClick="CancelWizard">Cancel</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="FinishWizard" Disabled="@(string.IsNullOrWhiteSpace(_newDevice.Name))">
                Add Device
            </MudButton>
        }
    </DialogActions>
</MudDialog>

<style>
    .device-type-card {
        transition: all 0.2s ease;
        border: 2px solid transparent;
    }

    .device-type-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .device-type-card.selected {
        border-color: var(--mud-palette-primary);
        background-color: rgba(var(--mud-palette-primary-rgb), 0.1);
    }
</style>


